<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Historia</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <style>
    :root { --ok:#1a8f2a; --bad:#c40000; --main:#2b7cff; --bg:#f6f7fb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; margin: 18px; line-height: 1.35; background: var(--bg); }
    h1 { margin: 0 0 6px; }
    .topBar {
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      background:white; border:1px solid #e5e7ef; border-radius:14px; padding:12px;
      box-shadow: 0 1px 8px rgba(0,0,0,.04);
    }
    .badge { padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fff; }
    .badge strong { margin-right:6px; }
    .tabs { display: flex; gap: 10px; margin: 14px 0; flex-wrap: wrap; }
    .tabBtn {
      padding: 10px 14px; border: 1px solid #2a2a2a; background: #fff; cursor: pointer;
      border-radius: 10px; font-weight: 700;
    }
    .tabBtn.active { background: #2a2a2a; color: white; }

    .panel {
      display: none; border: 1px solid #e5e7ef; padding: 14px; border-radius: 16px;
      background:white; box-shadow: 0 1px 8px rgba(0,0,0,.04);
    }
    .panel.active { display: block; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .controls { margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      padding: 10px 14px; border: none; background: var(--main); color: white; cursor: pointer;
      border-radius: 12px; font-weight: 800;
    }
    button.secondary { background: #666; }
    button.ghost { background: white; color:#222; border:1px solid #cfd3e0; }
    button.warn { background: #ffb020; color:#222; }
    button:disabled {
  opacity: 1;
  cursor: not-allowed;
  background: #f3f3f3;
  color: #222;
  border: 1px solid #cfd3e0;
}


    .progressWrap { margin: 10px 0 2px; }
    .progressBar { height: 10px; width: 100%; background: #eef1f8; border-radius: 999px; overflow:hidden; border:1px solid #e3e8f3; }
    .progressFill { height: 100%; width: 0%; background: var(--main); transition: width .25s ease; }
    .small { font-size: 0.92em; color: #555; }

    .question {
      margin: 12px 0; padding: 12px; border: 1px solid #eef0f6; border-radius: 14px;
      background: #fff;
    }
    .question.correct { border-color: rgba(26,143,42,.35); background: rgba(26,143,42,.06); }
    .question.wrong { border-color: rgba(196,0,0,.35); background: rgba(196,0,0,.05); }
    .qTitle { font-weight: 900; margin-bottom: 8px; }
    .answers label { display: block; margin: 6px 0; cursor: pointer; padding:6px 8px; border-radius: 10px; }
    .answers label:hover { background:#f3f6ff; }
    input[type="text"] {
      width: 100%; padding: 10px; border-radius: 12px; border: 1px solid #b8bfd3; font-size: 1em;
    }
    .keyAnswer { font-size: 0.92em; margin-top: 8px; color: #222; }
    .pill { display:inline-block; padding:4px 10px; border-radius: 999px; border:1px solid #ddd; background:#fff; margin: 4px 6px 0 0; }
    .resultBox {
      margin-top: 14px; padding: 12px; border-radius: 16px; background: #f7f8fc;
      border: 1px solid #e3e6f2;
    }
    .good { color: var(--ok); font-weight: 900; }
    .bad { color: var(--bad); font-weight: 900; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 780px){ .grid2{ grid-template-columns:1fr; } }
    .footerNote { margin-top: 10px; font-size: 0.92em; color: #444; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>

<h1>Sprawdzian ‚Äì Dzia≈Ç 4 (Historia, klasa 5) üî•</h1>
<p class="small">Tryb ‚Äûna wypasie‚Äù: timer, losowanie, pod≈õwietlanie, powt√≥rka b≈Çƒôd√≥w, tolerancja w otwartych ‚úÖ</p>

<div class="topBar">
  <span class="badge"><strong>Timer:</strong> <span id="timerText" class="mono">--:--</span></span>
  <span class="badge"><strong>Najlepszy wynik:</strong> <span id="bestScore">brak</span></span>
  <span class="badge"><strong>Tryb:</strong> <span id="modeName">ABC</span></span>

  <div class="row">
    <label class="badge">
      <strong>Czas (min):</strong>
      <input id="minutesInput" type="number" min="1" max="90" value="20" style="width:70px; padding:6px; border-radius:10px; border:1px solid #cfd3e0;">
    </label>

    <button class="ghost" onclick="startTimer()">Start</button>
    <button class="secondary" onclick="pauseTimer()">Pauza</button>
    <button class="ghost" onclick="resetTimer()">Reset</button>
  </div>
</div>

<div class="tabs">
  <button id="tabBtnABC" class="tabBtn active" onclick="openTab('abc')">Test ABC</button>
  <button id="tabBtnOPEN" class="tabBtn" onclick="openTab('open')">Test otwarty</button>
</div>

<!-- ===================== ABC ===================== -->
<div id="panel-abc" class="panel active">
  <div class="grid2">
    <div>
      <h2>‚úÖ Test ABC</h2>
      <p class="small">Losuje <b id="abcCountText">20</b> pyta≈Ñ z wiƒôkszej bazy. Kliknij odpowiedzi.</p>
    </div>
    <div>
      <div class="progressWrap">
        <div class="small">Postƒôp: <span id="abcProgressText">0%</span></div>
        <div class="progressBar"><div id="abcProgressFill" class="progressFill"></div></div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="warn" onclick="shuffleABC()">Losuj pytania + mieszaj odpowiedzi</button>
    <button onclick="checkABC()">Sprawd≈∫ wynik</button>
    <button class="ghost" onclick="showWrongOnly('abc')">Poka≈º tylko b≈Çƒôdne</button>
    <button class="secondary" onclick="resetABC()">Reset</button>
    <button class="ghost" onclick="showAll('abc')">Poka≈º wszystkie</button>
  </div>

  <div id="abcQuestions"></div>
  <div id="abcResult" class="resultBox" style="display:none;"></div>
</div>

<!-- ===================== OPEN ===================== -->
<div id="panel-open" class="panel">
  <div class="grid2">
    <div>
      <h2>‚úÖ Test otwarty</h2>
      <p class="small">
        Losuje <b id="openCountText">10</b> pyta≈Ñ z wiƒôkszej bazy. Wpisuj odpowiedzi swoimi s≈Çowami.
        System akceptuje wiele wersji + toleruje drobne liter√≥wki.
      </p>
      <p class="small">
        Tip: Staraj siƒô pisaƒá najwa≈ºniejsze s≈Çowa-klucze (np. ‚Äûucieczka‚Äù, ‚ÄûMedyna‚Äù, ‚Äû622‚Äù).
      </p>
    </div>
    <div>
      <div class="progressWrap">
        <div class="small">Postƒôp: <span id="openProgressText">0%</span></div>
        <div class="progressBar"><div id="openProgressFill" class="progressFill"></div></div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="warn" onclick="shuffleOPEN()">Losuj pytania</button>
    <button onclick="checkOpen()">Sprawd≈∫ wynik</button>
    <button class="ghost" onclick="showWrongOnly('open')">Poka≈º tylko b≈Çƒôdne</button>
    <button class="secondary" onclick="resetOpen()">Reset</button>
    <button class="ghost" onclick="showAll('open')">Poka≈º wszystkie</button>
  </div>

  <div id="openQuestions"></div>
  <div id="openResult" class="resultBox" style="display:none;"></div>
</div>

<script>
  // ===================== ILE LOSOWAƒÜ DO TESTU =====================
  const ABC_DRAW = 20;
  const OPEN_DRAW = 10;

  // Uaktualnij napisy w UI
  document.getElementById("abcCountText").textContent = String(ABC_DRAW);
  document.getElementById("openCountText").textContent = String(OPEN_DRAW);
  document.getElementById("tabBtnABC").textContent = `Test ABC (${ABC_DRAW} pyta≈Ñ)`;
  document.getElementById("tabBtnOPEN").textContent = `Test otwarty (${OPEN_DRAW} pyta≈Ñ)`;

  // ===================== UTIL: localStorage best score =====================
  const BEST_KEY = "dzial4_bestscore";
  function loadBest() {
    const v = localStorage.getItem(BEST_KEY);
    document.getElementById("bestScore").textContent = v ? v : "brak";
  }
  function saveBest(text, percent) {
    const old = localStorage.getItem(BEST_KEY);
    if (!old) {
      localStorage.setItem(BEST_KEY, text);
      loadBest();
      return;
    }
    const oldPercent = Number((old.match(/(\d+)%/)||[])[1] || 0);
    if (percent > oldPercent) {
      localStorage.setItem(BEST_KEY, text);
      loadBest();
    }
  }
  loadBest();

  // ===================== TIMER =====================
  let timerSeconds = 0;
  let timerId = null;
  let timerRunning = false;

  function formatTime(s) {
    const m = Math.floor(s/60);
    const sec = s % 60;
    return String(m).padStart(2,"0") + ":" + String(sec).padStart(2,"0");
  }
  function updateTimerUI() {
    document.getElementById("timerText").textContent = formatTime(timerSeconds);
  }
  function startTimer() {
    if (timerRunning) return;
    const mins = Number(document.getElementById("minutesInput").value || 20);
    if (timerSeconds === 0) timerSeconds = mins * 60;
    timerRunning = true;
    timerId = setInterval(() => {
      timerSeconds--;
      updateTimerUI();
      if (timerSeconds <= 0) {
        clearInterval(timerId);
        timerRunning = false;
        timerSeconds = 0;
        updateTimerUI();
        alert("‚è∞ Czas minƒÖ≈Ç! Mo≈ºesz sprawdziƒá wynik.");
      }
    }, 1000);
  }
  function pauseTimer() {
    if (!timerRunning) return;
    clearInterval(timerId);
    timerRunning = false;
  }
  function resetTimer() {
    pauseTimer();
    const mins = Number(document.getElementById("minutesInput").value || 20);
    timerSeconds = mins * 60;
    updateTimerUI();
  }
  resetTimer();

  // ===================== TAB =====================
  function openTab(tabName) {
    document.querySelectorAll(".tabBtn").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));

    if(tabName === "abc") {
      document.getElementById("tabBtnABC").classList.add("active");
      document.getElementById("panel-abc").classList.add("active");
      document.getElementById("modeName").textContent = "ABC";
    } else {
      document.getElementById("tabBtnOPEN").classList.add("active");
      document.getElementById("panel-open").classList.add("active");
      document.getElementById("modeName").textContent = "Otwarty";
    }
  }

  // ===================== HELPERS =====================
  function deepCopy(o){ return JSON.parse(JSON.stringify(o)); }

  function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
  }

  // losowe N bez powt√≥rek
  function pickRandomN(arr, n){
    const tmp = deepCopy(arr);
    shuffleArray(tmp);
    return tmp.slice(0, Math.min(n, tmp.length));
  }

  // ===================== DATA: ABC (BAZA > 20) =====================
  // TYLKO to, co ju≈º masz: te same fakty, tylko inne sformu≈Çowanie / pytanie na to samo.
  const abcBase = [
  // oryginalne 20 (bez numer√≥w)
  { q:"W kt√≥rym roku powsta≈Ço Bizancjum?", a:["476 r.","395 r.","800 r.","1453 r."], c:1 },
  { q:"StolicƒÖ Bizancjum by≈Ç:", a:["Rzym","Ateny","Konstantynopol","Medyna"], c:2 },
  { q:"Konstantynopol le≈ºa≈Ç nad cie≈õninƒÖ:", a:["Gibraltar","Bosfor","Suez","Dardanele"], c:1 },
  { q:"Najwiƒôksza ≈õwietno≈õƒá Bizancjum przypada na wiek:", a:["V","VI","IX","XII"], c:1 },
  { q:"Cesarz, za kt√≥rego czas√≥w zbudowano Hagia Sophia:", a:["Justynian I","Karol Wielki","Otton I","Henryk IV"], c:0 },
  { q:"Kodeks Justyniana to:", a:["kronika bitew","spisane prawo rzymskie","modlitwy islamu","traktat pokojowy"], c:1 },
  { q:"W kt√≥rym roku Turcy zdobyli Konstantynopol?", a:["1054","1122","1453","622"], c:2 },
  { q:"Zdobycie Konstantynopola w 1453 r. jest uznawane za symboliczny:", a:["poczƒÖtek staro≈ºytno≈õci","poczƒÖtek renesansu","koniec ≈õredniowiecza","koniec nowo≈ºytno≈õci"], c:2 },
  { q:"Tw√≥rcƒÖ islamu by≈Ç:", a:["Chlodwig","Mahomet","Leon III","Karol M≈Çot"], c:1 },
  { q:"Jak muzu≈Çmanie nazywajƒÖ Boga?", a:["Jahwe","Allah","Zeus","Chrystus"], c:1 },
  { q:"≈öwiƒôta ksiƒôga islamu to:", a:["Biblia","Tora","Koran","Ewangelia"], c:2 },
  { q:"Hid≈ºra to:", a:["budowa Hagii Sophii","ucieczka Mahometa do Medyny","koronacja Karola Wielkiego","traktat w Verdun"], c:1 },
  { q:"Rok hid≈ºry (poczƒÖtek ery muzu≈Çma≈Ñskiej) to:", a:["610","622","732","843"], c:1 },
  { q:"Kalifowie to:", a:["w≈Çadcy po Mahomecie","rycerze krzy≈ºowi","patriarchowie","mnisi"], c:0 },
  { q:"D≈ºihad oznacza:", a:["zakaz handlu","walkƒô w obronie wiary","pok√≥j miƒôdzy religiami","wyb√≥r biskup√≥w"], c:1 },
  { q:"Bitwa pod Poitiers odby≈Ça siƒô w roku:", a:["732","800","843","962"], c:0 },
  { q:"Kto dowodzi≈Ç Frankami pod Poitiers?", a:["Karol M≈Çot","Pepin Ma≈Çy","Karol Wielki","Justynian"], c:0 },
  { q:"Karol Wielki zosta≈Ç koronowany na cesarza w:", a:["395","800","962","1054"], c:1 },
  { q:"Traktat w Verdun podpisano w:", a:["732","843","962","1122"], c:1 },
  { q:"Wielka schizma wschodnia mia≈Ça miejsce w:", a:["1054","1077","1122","1453"], c:0 },

  // dodatkowe (te same fakty, inne pytania) (bez numer√≥w)
  { q:"Bizancjum powsta≈Ço po podziale Cesarstwa Rzymskiego w roku:", a:["395 r.","476 r.","800 r.","1054 r."], c:0 },
  { q:"Inna nazwa Bizancjum to:", a:["Cesarstwo Bizantyjskie","Cesarstwo Frank√≥w","Pa≈Ñstwo Papieskie","Kr√≥lestwo Polskie"], c:0 },
  { q:"W jakim wieku panowa≈Ça najwiƒôksza ≈õwietno≈õƒá Bizancjum?", a:["VI","V","XII","IX"], c:0 },
  { q:"Hagia Sophia zosta≈Ça zbudowana za panowania:", a:["Justyniana I","Henryka IV","Ottona I","Karola Wielkiego"], c:0 },
  { q:"Kodeks Justyniana by≈Ç zwiƒÖzany z:", a:["prawem rzymskim","modlitwami islamu","traktatem w Verdun","bitwƒÖ pod Poitiers"], c:0 },
  { q:"Konstantynopol to by≈Ça stolica:", a:["Bizancjum","Rzymu","Aten","Medyny"], c:0 },
  { q:"Cie≈õnina, nad kt√≥rƒÖ le≈ºa≈Ç Konstantynopol, to:", a:["Bosfor","Suez","Gibraltar","Dardanele"], c:0 },
  { q:"Rok 1453 wiƒÖ≈ºe siƒô z wydarzeniem:", a:["zdobyciem Konstantynopola","traktatem w Verdun","koronacjƒÖ Karola Wielkiego","hid≈ºrƒÖ"], c:0 },
  { q:"Zdobycie Konstantynopola (1453) uznaje siƒô za symboliczny:", a:["koniec ≈õredniowiecza","poczƒÖtek staro≈ºytno≈õci","koniec nowo≈ºytno≈õci","poczƒÖtek staro≈ºytno≈õci"], c:0 },
  { q:"Islam powsta≈Ç dziƒôki dzia≈Çalno≈õci:", a:["Mahometa","Karola M≈Çota","Leona III","Chlodwiga"], c:0 },
  { q:"Jak brzmi nazwa Boga w islamie?", a:["Allah","Jahwe","Zeus","Chrystus"], c:0 },
  { q:"≈öwiƒôta ksiƒôga islamu to:", a:["Koran","Tora","Biblia","Ewangelia"], c:0 },
  { q:"Hid≈ºra oznacza:", a:["ucieczkƒô Mahometa do Medyny","traktat w Verdun","budowƒô Hagii Sophii","wielkƒÖ schizmƒô wschodniƒÖ"], c:0 },
  { q:"PoczƒÖtek ery muzu≈Çma≈Ñskiej to rok:", a:["622","610","732","843"], c:0 },
  { q:"Kalif to:", a:["w≈Çadca po Mahomecie","mnich","patriarcha","rycerz krzy≈ºowy"], c:0 },
  { q:"D≈ºihad to:", a:["walka w obronie wiary","zakaz handlu","pok√≥j miƒôdzy religiami","wyb√≥r biskup√≥w"], c:0 },
  { q:"Rok 732 dotyczy:", a:["bitwy pod Poitiers","koronacji Karola Wielkiego","traktatu w Verdun","wielkiej schizmy wschodniej"], c:0 },
  { q:"Dow√≥dcƒÖ Frank√≥w pod Poitiers by≈Ç:", a:["Karol M≈Çot","Pepin Ma≈Çy","Karol Wielki","Justynian I"], c:0 },
  { q:"Karol Wielki zosta≈Ç cesarzem w roku:", a:["800","843","962","395"], c:0 },
  { q:"Traktat w Verdun zawarto w roku:", a:["843","732","1122","1054"], c:0 },
  { q:"Wielka schizma wschodnia mia≈Ça miejsce w roku:", a:["1054","1077","1122","1453"], c:0 },

  // kilka ‚Äûodwr√≥conych‚Äù (nadal te same dane) (bez numer√≥w)
  { q:"Kt√≥ry rok to hid≈ºra (poczƒÖtek ery muzu≈Çma≈Ñskiej)?", a:["622","732","843","800"], c:0 },
  { q:"Kt√≥ry rok to traktat w Verdun?", a:["843","1122","1054","1453"], c:0 },
  { q:"Kt√≥ry rok to bitwa pod Poitiers?", a:["732","800","962","395"], c:0 },
  { q:"Kt√≥ry rok to zdobycie Konstantynopola przez Turk√≥w?", a:["1453","1054","1122","622"], c:0 },

  // === DODATKOWE PYTANIA ABC (z notatek/fiszek) (bez "(DOD)") ===
  { q:"Bizancjum to inaczej:", a:["Cesarstwo Wschodniorzymskie","Cesarstwo Zachodniorzymskie","Pa≈Ñstwo Frank√≥w","Kalifat"], c:0 },
  { q:"Stolica Bizancjum by≈Ça nazywana te≈º:", a:["Nowy Rzym","Stary Rzym","Nowa Mekka","Nowa Galia"], c:0 },
  { q:"Konstantynopol le≈ºa≈Ç na granicy:", a:["Europy i Azji","Afryki i Azji","Europy i Afryki","Ameryki i Europy"], c:0 },
  { q:"Dlaczego Konstantynopol by≈Ç silnie broniony? (wybierz najlepszƒÖ)", a:["mury + wody + ≈Ça≈Ñcuchy przeciw okrƒôtom","pustynia dooko≈Ça","brak dostƒôpu do morza","tylko drewniane p≈Çoty"], c:0 },
  { q:"Cesarz w Bizancjum by≈Ç tak≈ºe:", a:["g≈ÇowƒÖ pa≈Ñstwa i wojska","tylko dow√≥dcƒÖ wojska","tylko kap≈Çanem","tylko sƒôdziƒÖ"], c:0 },
  { q:"Justynian I Wielki panowa≈Ç w wieku:", a:["VI","V","IX","XII"], c:0 },
  { q:"Justynian I kaza≈Ç spisaƒá:", a:["prawo rzymskie","modlitwy islamu","kronikƒô bitew Frank√≥w","legendy o Canossie"], c:0 },
  { q:"Hagia Sophia by≈Ça:", a:["wielkƒÖ bazylikƒÖ w Konstantynopolu","twierdzƒÖ w Galii","meczetem w Medynie","pa≈Çacem w Rzymie"], c:0 },
  { q:"Co by≈Ço charakterystyczne dla Hagii Sophii?", a:["wielka kopu≈Ça i okna dajƒÖce efekt ‚Äûunoszenia‚Äù","piramidy i sfinks","wie≈ºa minaret","drewniany dach bez okien"], c:0 },
  { q:"Wnƒôtrze Hagii Sophii zdobiono m.in.:", a:["mozaikami, marmurami i z≈Çotymi ozdobami","g≈Ç√≥wnie drewnem i glinƒÖ","wy≈ÇƒÖcznie freskami bez mozaik","samymi kamieniami bez ozd√≥b"], c:0 },
  { q:"Styl bizantyjski kojarzy≈Ç siƒô z:", a:["przepychem, kopu≈Çami i mozaikami","prostotƒÖ i brakiem ozd√≥b","drewnianymi chatach","samymi piramidami"], c:0 },
  { q:"Jedno z osiƒÖgniƒôƒá Bizancjum to:", a:["ratowanie rƒôkopis√≥w ze staro≈ºytno≈õci","wynalezienie prochu","odkrycie Ameryki","wprowadzenie alfabetu ≈Çaci≈Ñskiego"], c:0 },
  { q:"Bizancjum przez wieki atakowali m.in.:", a:["S≈Çowianie, Arabowie, Turcy","Grecy, Rzymianie, Wikingowie","Majowie, Aztekowie, Inkowie","Japo≈Ñczycy, Chi≈Ñczycy, Hindusi"], c:0 },
  { q:"Skutkiem zdobycia Konstantynopola w 1453 r. by≈Ça:", a:["≈õmierƒá ostatniego cesarza","powstanie Bizancjum","koronacja Karola Wielkiego","podpisanie konkordatu"], c:0 },
  { q:"Arabowie przed islamem mieszkali na:", a:["P√≥≈Çwyspie Arabskim","P√≥≈Çwyspie Iberyjskim","P√≥≈Çwyspie Apeni≈Ñskim","P√≥≈Çwyspie Skandynawskim"], c:0 },
  { q:"Arabowie przed islamem ≈ºyli g≈Ç√≥wnie:", a:["koczowniczo","w wielkich miastach przemys≈Çowych","tylko na wybrze≈ºu","w d≈ºungli"], c:0 },
  { q:"Wa≈ºna miejscowo≈õƒá Arab√≥w przed islamem to:", a:["Mekka","Ateny","Konstantynopol","Gniezno"], c:0 },
  { q:"Kaaba znajduje siƒô w:", a:["Mekce","Medynie","Konstantynopolu","Rzymie"], c:0 },
  { q:"Czarny Kamie≈Ñ jest zwiƒÖzany z:", a:["KaabƒÖ i MekkƒÖ","Kodeksem Justyniana","traktatem w Verdun","CanossƒÖ"], c:0 },
  { q:"Islam to religia:", a:["monoteistyczna","politeistyczna","bez bog√≥w","oparta na wielu bogach"], c:0 },
  { q:"Jak nazywa siƒô B√≥g w islamie?", a:["Allah","Jahwe","Zeus","Chrystus"], c:0 },
  { q:"Koran to:", a:["≈õwiƒôta ksiƒôga islamu","≈õwiƒôta ksiƒôga chrze≈õcijan","kodeks prawa rzymskiego","traktat pokojowy"], c:0 },
  { q:"Modlitwa jest filarem islamu i odbywa siƒô:", a:["5 razy dziennie w stronƒô Mekki","1 raz w tygodniu w stronƒô Rzymu","2 razy dziennie w stronƒô Konstantynopola","10 razy dziennie w stronƒô Medyny"], c:0 },
  { q:"Minaret to:", a:["wie≈ºa, z kt√≥rej wzywa siƒô do modlitwy","wnƒôka pokazujƒÖca kierunek Mekki","kazalnica","kopu≈Ça bazyliki"], c:0 },
  { q:"Mihrab to:", a:["wnƒôka pokazujƒÖca kierunek Mekki","wie≈ºa przy meczecie","kazalnica","mury obronne"], c:0 },
  { q:"Minbar to:", a:["kazalnica","wie≈ºa przy meczecie","wnƒôka wskazujƒÖca kierunek Mekki","≈Ça≈Ñcuchy przeciw okrƒôtom"], c:0 },
  { q:"Po ≈õmierci Mahometa rzƒÖdzili:", a:["kalifowie","patriarchowie","majordomowie","Merowingowie"], c:0 },
  { q:"D≈ºihad oznacza:", a:["walkƒô w obronie wiary","zakaz handlu","pok√≥j miƒôdzy religiami","wyb√≥r biskup√≥w"], c:0 },
  { q:"W VII‚ÄìVIII w. Arabowie podbili ziemie:", a:["od Indii po Hiszpaniƒô (przez Bliski Wsch√≥d i Afrykƒô P≈Çn.)","tylko Skandynawiƒô","tylko Polskƒô i Wƒôgry","tylko Amerykƒô P√≥≈ÇnocnƒÖ"], c:0 },
  { q:"Jednym z osiƒÖgniƒôƒá Arab√≥w by≈Ç rozw√≥j:", a:["matematyki i nauk (np. cyfry arabskie)","budowy piramid","feudalizmu w Europie","traktat√≥w w Verdun"], c:0 },
  { q:"Frankowie osiedlili siƒô w:", a:["Galii","Italii","Hispanii","Arabii"], c:0 },
  { q:"Chlodwig przyjƒÖ≈Ç chrze≈õcija≈Ñstwo w roku:", a:["496","395","732","843"], c:0 },
  { q:"Dynastia rzƒÖdzƒÖca u Frank√≥w za czas√≥w Chlodwiga to:", a:["Merowingowie","Karolingowie","Piastowie","Jagiellonowie"], c:0 },
  { q:"Majordomowie to:", a:["osoby majƒÖce realnƒÖ w≈Çadzƒô u Frank√≥w","mnisi w Bizancjum","kalifowie po Mahomecie","patriarchowie Konstantynopola"], c:0 },
  { q:"Pepin Ma≈Çy przejƒÖ≈Ç w≈Çadzƒô w roku:", a:["751","732","800","962"], c:0 },
  { q:"Dynastia Pepina i Karola Wielkiego to:", a:["Karolingowie","Merowingowie","Habsburgowie","Romanowowie"], c:0 },
  { q:"Bitwa pod Poitiers (732 r.) zako≈Ñczy≈Ça siƒô:", a:["zatrzymaniem najazdu Arab√≥w na Europƒô ZachodniƒÖ","zdobyciem Konstantynopola","podzia≈Çem pa≈Ñstwa Frank√≥w","wielkƒÖ schizmƒÖ wschodniƒÖ"], c:0 },
  { q:"Karol Wielki zosta≈Ç koronowany na cesarza w:", a:["800","843","962","1054"], c:0 },
  { q:"Traktat w Verdun (843 r.) oznacza≈Ç:", a:["podzia≈Ç pa≈Ñstwa na 3 czƒô≈õci","koniec Bizancjum","poczƒÖtek islamu","zako≈Ñczenie sporu o inwestyturƒô"], c:0 },
  { q:"Z podzia≈Çu po Verdun w przysz≈Ço≈õci powsta≈Çy:", a:["Francja, Niemcy, W≈Çochy","Polska, Czechy, Wƒôgry","Hiszpania, Portugalia, Anglia","Szwecja, Norwegia, Dania"], c:0 },
  { q:"Wielka schizma wschodnia mia≈Ça miejsce w:", a:["1054","1077","1122","1453"], c:0 },
  { q:"Skutkiem schizmy by≈Ç podzia≈Ç chrze≈õcija≈Ñstwa na:", a:["katolicyzm i prawos≈Çawie","islam i judaizm","protestantyzm i islam","poga≈Ñstwo i chrze≈õcija≈Ñstwo"], c:0 },
  { q:"Inwestytura to sp√≥r o:", a:["mianowanie biskup√≥w","zdobycie Konstantynopola","podzia≈Ç pa≈Ñstwa Frank√≥w","piƒôƒá filar√≥w islamu"], c:0 },
  { q:"Papie≈º w sporze o inwestyturƒô to:", a:["Grzegorz VII","Henryk IV","Justynian I","Karol Wielki"], c:0 },
  { q:"Cesarz w sporze o inwestyturƒô to:", a:["Henryk IV","Grzegorz VII","Mahomet","Chlodwig"], c:0 },
  { q:"Canossa (1077 r.) to:", a:["spotkanie Henryka IV z papie≈ºem i pro≈õba o cofniƒôcie klƒÖtwy","podzia≈Ç pa≈Ñstwa na 3 czƒô≈õci","zdobycie Konstantynopola","hid≈ºra"], c:0 },
  { q:"Konkordat w Wormacji podpisano w:", a:["1122","1054","843","622"], c:0 },
  { q:"Kompromis w Wormacji oznacza≈Ç, ≈ºe biskup√≥w wybiera:", a:["Ko≈õci√≥≈Ç","cesarz","kalif","majordom"], c:0 },
  { q:"W≈õr√≥d najwa≈ºniejszych dat jest koronacja Ottona I w roku:", a:["962","800","751","496"], c:0 },
];

  // ===================== ABC: build/render/check/reset =====================
  let abcData = [];
function cleanQuestionText(q){
  return (q ?? "")
    .replace(/\uFEFF/g, "")                         // usu≈Ñ BOM
    .replace(/^\s*(?:\/\/.*\n)*/g, "")              // usu≈Ñ linie komentarzy na poczƒÖtku
    .replace(/^\s*\(DOD\)\s*/i, "")                 // (DOD)
    .replace(/^\s*\d+\s*[\.\)\-:]\s*/m, "")         // 1. 1) 1- 1:
    .replace(/^\s*\d+\s+/m, "")                     // 1 tekst
    .trim();
}

  function buildABC(drawCount=ABC_DRAW, shuffleAnswers=true){
  abcData = pickRandomN(abcBase, drawCount);

  // ‚úÖ czy≈õƒá pytania z numerk√≥w / (DOD)
  abcData.forEach(item => {
    item.q = cleanQuestionText(item.q);
  });

  if(shuffleAnswers){
    abcData.forEach(item=>{
      const correctText = item.a[item.c];
      shuffleArray(item.a);
      item.c = item.a.indexOf(correctText);
    });
  }
}


  function renderABC() {
  const container = document.getElementById("abcQuestions");
  container.innerHTML = "";

  abcData.forEach((item, idx) => {
    const div = document.createElement("div");
    div.className = "question";
    div.id = `abcQ_${idx}`;

    div.innerHTML = `
      <div class="qTitle">${cleanQuestionText(item.q)}</div>
      <div class="answers">
        ${item.a.map((ans, i) => `
          <label>
            <input type="radio" name="abc_${idx}" value="${i}">
            <b>${String.fromCharCode(65+i)}.</b> ${ans}
          </label>
        `).join("")}
      </div>
      <div class="keyAnswer" id="abcKey_${idx}" style="display:none;"></div>
    `;

    container.appendChild(div);
  });

  attachProgressListenersABC();
  updateProgress("abc");
}


  function checkABC() {
    let score = 0;
    let details = [];

    abcData.forEach((item, idx) => {
      const chosen = document.querySelector(`input[name="abc_${idx}"]:checked`);
      const chosenIndex = chosen ? Number(chosen.value) : null;

      const qDiv = document.getElementById(`abcQ_${idx}`);
      const key = document.getElementById(`abcKey_${idx}`);
      key.style.display = "block";
      key.innerHTML = `Poprawna: <span class="pill"><b>${String.fromCharCode(65+item.c)}.</b> ${item.a[item.c]}</span>`;

      if (chosenIndex === item.c) {
        score++;
        qDiv.classList.remove("wrong");
        qDiv.classList.add("correct");
        details.push(`<div class="good">‚úî ${cleanQuestionText(item.q)}</div>`);
      } else {
        qDiv.classList.remove("correct");
        qDiv.classList.add("wrong");
        details.push(`<div class="bad">‚úò ${cleanQuestionText(item.q)}</div>`);
      }
    });

    const percent = Math.round((score / abcData.length) * 100);
    const grade = gradeFromPercent(percent);

    const result = document.getElementById("abcResult");
    result.style.display = "block";
    result.innerHTML = `
      <h3>Wynik: ${score} / ${abcData.length} (${percent}%) ‚Äî Ocena: <span class="${percent>=50?'good':'bad'}">${grade}</span></h3>
      <div class="small">Powt√≥rka: kliknij ‚ÄûPoka≈º tylko b≈Çƒôdne‚Äù, ≈ºeby ƒáwiczyƒá same trudne pytania.</div>
      <hr style="border:none;border-top:1px solid #e3e6f2;margin:10px 0;">
      ${details.join("")}
    `;

    saveBest(`ABC: ${score}/${abcData.length} (${percent}%)`, percent);
  }

  function resetABC() {
    document.querySelectorAll(`#abcQuestions input[type="radio"]`).forEach(r => r.checked = false);
    document.querySelectorAll(`#abcQuestions .question`).forEach((q)=>{
      q.classList.remove("correct","wrong");
      const id = q.id.replace("abcQ_","");
      const key = document.getElementById(`abcKey_${id}`);
      if(key) key.style.display = "none";
    });
    document.getElementById("abcResult").style.display = "none";
    updateProgress("abc");
    showAll("abc");
  }

  function shuffleABC(){
    // nowy los + mieszanie odpowiedzi
    buildABC(ABC_DRAW, true);
    renderABC();
    resetABC();
  }

  // ===================== DATA: OPEN (BAZA > 10) =====================
  // TYLKO to, co ju≈º masz: te same odpowiedzi/pojƒôcia, inne sformu≈Çowania.
  const openBase = [
    {
  q:"Co to by≈Ço Bizancjum?",
  accepted:["Cesarstwo Wschodniorzymskie","Cesarstwo Bizantyjskie"],
  must:["cesarstw"],
  any:["wschodniorzymsk","bizantyj"],
  explain:"Np. Cesarstwo Wschodniorzymskie (Bizancjum)."
},
{
  q:"Podaj stolicƒô Bizancjum.",
  accepted:["Konstantynopol"],
  must:["konstantynopol"],
  explain:"Konstantynopol."
},
{
  q:"Wymie≈Ñ 5 filar√≥w islamu.",
  accepted:[
    "wyznanie wiary, modlitwa, ja≈Çmu≈ºna, post, pielgrzymka",
    "wiara, modlitwa, ja≈Çmu≈ºna, post, pielgrzymka do Mekki"
  ],
  requiredStemsAnyOf:["wiar","modlitw","jalmu","post","pielgrzym"],
  minMatch:4,
  explain:"Wyznanie wiary, modlitwa, ja≈Çmu≈ºna, post, pielgrzymka do Mekki."
},
{
  q:"Co to by≈Ça hid≈ºra i w kt√≥rym roku?",
  accepted:[
    "Ucieczka Mahometa z Mekki do Medyny w 622 roku",
    "Ucieczka Mahometa do Medyny w 622"
  ],
  must:["ucieczk","medyn","622"],
  explain:"Ucieczka Mahometa z Mekki do Medyny w 622 r."
},
{
  q:"Podaj rok koronacji Karola Wielkiego na cesarza.",
  accepted:["800","800 r.","w 800 roku"],
  must:["800"],
  explain:"800 r."
},
{
  q:"Co ustali≈Ç traktat w Verdun (843 r.)?",
  accepted:[
    "Podzia≈Ç pa≈Ñstwa Karola Wielkiego na trzy czƒô≈õci",
    "Podzia≈Ç pa≈Ñstwa Frank√≥w na trzy czƒô≈õci"
  ],
  must:["podzial","trz"],
  any:["verdun","panstw","frank","karol"],
  explain:"Podzia≈Ç pa≈Ñstwa Karola Wielkiego na 3 czƒô≈õci."
},
{
  q:"Co wydarzy≈Ço siƒô w 1054 roku?",
  accepted:[
    "Wielka schizma wschodnia",
    "Podzia≈Ç Ko≈õcio≈Ça na katolicki i prawos≈Çawny"
  ],
  any:["schizm","podzial kosciola","katolic","prawoslaw"],
  explain:"Wielka schizma wschodnia ‚Äì podzia≈Ç na katolicyzm i prawos≈Çawie."
},
{
  q:"Na czym polega≈Ç sp√≥r o inwestyturƒô?",
  accepted:[
    "Sp√≥r o to, kto ma mianowaƒá biskup√≥w",
    "Sp√≥r o prawo mianowania biskup√≥w"
  ],
  must:["biskup"],
  any:["mianow","wybier","inwestyt"],
  explain:"Sp√≥r o mianowanie (wyb√≥r) biskup√≥w."
},
{
  q:"Co wydarzy≈Ço siƒô w Canossie (1077 r.)?",
  accepted:[
    "Spotkanie papie≈ºa Grzegorza VII z cesarzem Henrykiem IV",
    "Henryk IV prosi≈Ç papie≈ºa o zdjƒôcie klƒÖtwy"
  ],
  must:["1077"],
  any:["canoss","henryk","grzegorz","klatw","papiez"],
  explain:"W 1077 r. Henryk IV spotka≈Ç siƒô z papie≈ºem Grzegorzem VII w Canossie (prosi≈Ç o cofniƒôcie klƒÖtwy)."
},
{
  q:"Jak nazywa siƒô porozumienie z 1122 r., kt√≥re zako≈Ñczy≈Ço sp√≥r o inwestyturƒô?",
  accepted:[
    "Konkordat w Wormacji",
    "Konkordat wormacki"
  ],
  must:["1122"],
  any:["wormac","konkordat"],
  explain:"Konkordat w Wormacji (1122 r.)."
},

// dodatkowe ‚Äì te same informacje, inne pytanie
{
  q:"Jak inaczej nazywamy Bizancjum?",
  accepted:["Cesarstwo Bizantyjskie","Cesarstwo Wschodniorzymskie"],
  must:["cesarstw"],
  any:["bizantyj","wschodniorzymsk"],
  explain:"Cesarstwo Bizantyjskie / Wschodniorzymskie."
},
{
  q:"Podaj rok hid≈ºry (poczƒÖtek ery muzu≈Çma≈Ñskiej).",
  accepted:["622","622 r.","w 622 roku"],
  must:["622"],
  explain:"622 r."
},
{
  q:"Podaj rok traktatu w Verdun.",
  accepted:["843","843 r.","w 843 roku"],
  must:["843"],
  explain:"843 r."
},
{
  q:"Podaj rok bitwy pod Poitiers.",
  accepted:["732","732 r.","w 732 roku"],
  must:["732"],
  explain:"732 r."
},
{
  q:"Podaj kto dowodzi≈Ç Frankami pod Poitiers.",
  accepted:["Karol M≈Çot","Karol Mlot"],
  must:["karol"],
  any:["mlot"],
  explain:"Karol M≈Çot."
},

// === DODATKOWE PYTANIA OTWARTE (z notatek/fiszek) ===
{
  q:"Dlaczego Konstantynopol by≈Ç wa≈ºny? Podaj 2 powody.",
  accepted:["po≈Ço≈ºenie Europa‚ÄìAzja i handel","po≈Ço≈ºenie (Europa i Azja) oraz centrum handlu","silne mury i handel","centrum handlu i silne umocnienia"],
  any:["europ","azj","handl","mury","bosfor","bron"],
  explain:"Np. po≈Ço≈ºenie na granicy Europy i Azji + centrum handlu (albo silne umocnienia)."
},
{
  q:"Co kaza≈Ç spisaƒá Justynian I? (jak nazywa siƒô ten zbi√≥r?)",
  accepted:["prawo rzymskie (Kodeks Justyniana)","Kodeks Justyniana","spisane prawo rzymskie"],
  must:["kodeks"],
  any:["justyn","prawo rzymsk"],
  explain:"Spisane prawo rzymskie ‚Äì Kodeks Justyniana."
},
{
  q:"W jakim wieku przypada najwiƒôksza ≈õwietno≈õƒá Bizancjum?",
  accepted:["VI","VI w.","w VI wieku"],
  must:["vi"],
  explain:"VI wiek."
},
{
  q:"Co to jest Hagia Sophia?",
  accepted:["wielka bazylika w Konstantynopolu","bazylika w Konstantynopolu"],
  must:["konstantynopol"],
  any:["bazylik","hagia"],
  explain:"Wielka bazylika w Konstantynopolu."
},
{
  q:"Podaj 2 przyk≈Çady ozd√≥b/element√≥w wnƒôtrza ko≈õcio≈Ç√≥w bizantyjskich.",
  accepted:["mozaiki i freski","mozaiki, marmury, z≈Çote ozdoby","mozaiki i marmury"],
  any:["mozaik","fresk","marmur","zlot"],
  explain:"Np. mozaiki i freski (albo marmury, z≈Çote ozdoby)."
},
{
  q:"Gdzie znajduje siƒô Kaaba?",
  accepted:["w Mekce","Mekka"],
  must:["mek"],
  any:["kaab"],
  explain:"Kaaba znajduje siƒô w Mekce."
},
{
  q:"Jak nazywa siƒô ≈õwiƒÖtynia zwiƒÖzana z Czarnym Kamieniem?",
  accepted:["Kaaba","Kaaba w Mekce"],
  must:["kaab"],
  explain:"Kaaba (w Mekce)."
},
{
  q:"Ile razy dziennie modlƒÖ siƒô muzu≈Çmanie i w kt√≥rƒÖ stronƒô?",
  accepted:["5 razy dziennie w stronƒô Mekki","piƒôƒá razy dziennie w stronƒô Mekki"],
  must:["5"],
  any:["mekk","stron"],
  explain:"5 razy dziennie w stronƒô Mekki."
},
{
  q:"Co to jest minaret?",
  accepted:["wie≈ºa przy meczecie (wezwanie do modlitwy)","wie≈ºa, z kt√≥rej wzywa siƒô do modlitwy"],
  must:["wiez"],
  any:["minaret","modlitw"],
  explain:"Minaret ‚Äì wie≈ºa, z kt√≥rej wzywa siƒô do modlitwy."
},
{
  q:"Co to jest mihrab?",
  accepted:["wnƒôka pokazujƒÖca kierunek Mekki","wnƒôka wskazujƒÖca kierunek Mekki"],
  must:["wnek"],
  any:["mekk","mihrab","kierunek"],
  explain:"Mihrab ‚Äì wnƒôka pokazujƒÖca kierunek Mekki."
},
{
  q:"Co to jest minbar?",
  accepted:["kazalnica","kazalnica w meczecie"],
  must:["kazal"],
  any:["minbar","meczet"],
  explain:"Minbar ‚Äì kazalnica (w meczecie)."
},
{
  q:"Kim byli majordomowie u Frank√≥w?",
  accepted:["mieli realnƒÖ w≈Çadzƒô","to oni mieli realnƒÖ w≈Çadzƒô","realnie rzƒÖdzili pa≈Ñstwem"],
  any:["realn","wladz","majordom"],
  explain:"Majordomowie mieli realnƒÖ w≈Çadzƒô (faktycznie rzƒÖdzili)."
},
{
  q:"Podaj rok koronacji Ottona I.",
  accepted:["962","962 r.","w 962 roku"],
  must:["962"],
  explain:"962 r."
},
  ];

  // ===================== NORMALIZACJA (PL) + FUZZY =====================
  function normalizeText(t) {
    return (t || "")
      .toLowerCase()
      .replaceAll("ƒÖ","a").replaceAll("ƒá","c").replaceAll("ƒô","e")
      .replaceAll("≈Ç","l").replaceAll("≈Ñ","n").replaceAll("√≥","o")
      .replaceAll("≈õ","s").replaceAll("≈º","z").replaceAll("≈∫","z")
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function levenshtein(a, b) {
    a = normalizeText(a); b = normalizeText(b);
    const m = a.length, n = b.length;
    if (m === 0) return n;
    if (n === 0) return m;
    const dp = Array.from({length: m+1}, () => Array(n+1).fill(0));
    for (let i=0;i<=m;i++) dp[i][0]=i;
    for (let j=0;j<=n;j++) dp[0][j]=j;
    for (let i=1;i<=m;i++){
      for (let j=1;j<=n;j++){
        const cost = a[i-1]===b[j-1] ? 0 : 1;
        dp[i][j] = Math.min(
          dp[i-1][j]+1,
          dp[i][j-1]+1,
          dp[i-1][j-1]+cost
        );
      }
    }
    return dp[m][n];
  }

  function similarity(a,b){
    a=normalizeText(a); b=normalizeText(b);
    const maxLen = Math.max(a.length,b.length);
    if (maxLen===0) return 1;
    const dist = levenshtein(a,b);
    return 1 - (dist/maxLen);
  }

  function containsAny(text, stems){
    const u = normalizeText(text);
    return stems.some(s=>u.includes(normalizeText(s)));
  }
  function containsAll(text, stems){
    const u = normalizeText(text);
    return stems.every(s=>u.includes(normalizeText(s)));
  }

  function isOpenCorrect(userAnswer, item){
    const u = normalizeText(userAnswer);
    if(!u) return false;

    if(item.requiredStemsAnyOf){
      const hits = item.requiredStemsAnyOf.filter(st => u.includes(normalizeText(st))).length;
      if(hits >= (item.minMatch || item.requiredStemsAnyOf.length)) return true;
    }

    if(item.must && item.must.length){
      const okMust = containsAll(u, item.must);
      if(okMust){
        if(item.any && item.any.length){
          if(containsAny(u, item.any)) return true;
          if(item.must.length >= 3) return true;
          return false;
        }
        return true;
      }
    }

    for(const acc of item.accepted){
      const an = normalizeText(acc);
      if(u === an) return true;
      if(u.includes(an) || an.includes(u)) return true;
    }

    for(const acc of item.accepted){
      const sim = similarity(u, acc);
      const threshold = (normalizeText(acc).length <= 12) ? 0.84 : 0.78;
      if(sim >= threshold) return true;
    }

    return false;
  }

  // ===================== OPEN: build/render/check/reset =====================
  let openData = [];

  function buildOPEN(drawCount=OPEN_DRAW){
  openData = pickRandomN(openBase, drawCount);
  openData.forEach(item => {
    item.q = cleanQuestionText(item.q);
  });
}

  function renderOPEN(){
    const container = document.getElementById("openQuestions");
    container.innerHTML = "";

    openData.forEach((item, idx)=>{
      const div = document.createElement("div");
      div.className = "question";
      div.id = `openQ_${idx}`;
      div.innerHTML = `
        <div class="qTitle">${cleanQuestionText(item.q)}</div>
        <input type="text" id="open_${idx}" placeholder="Wpisz odpowied≈∫..." />
        <div class="keyAnswer" id="openKey_${idx}" style="display:none;"></div>
      `;
      container.appendChild(div);
    });

    attachProgressListenersOPEN();
    updateProgress("open");
  }

  function attachProgressListenersOPEN(){
    openData.forEach((_,idx)=>{
      const inp = document.getElementById(`open_${idx}`);
      inp.addEventListener("input", ()=>updateProgress("open"));
    });
  }

  function checkOpen(){
    let score = 0;
    let details = [];

    openData.forEach((item, idx)=>{
      const input = document.getElementById(`open_${idx}`);
      const user = input.value;

      const correct = isOpenCorrect(user, item);

      const qDiv = document.getElementById(`openQ_${idx}`);
      const key = document.getElementById(`openKey_${idx}`);
      key.style.display = "block";

      const pills = item.accepted.slice(0,3).map(x=>`<span class="pill">${x}</span>`).join("");
      key.innerHTML = `
        <div><b>Przyk≈Çady poprawnych:</b> ${pills}</div>
        <div class="small"><b>Wz√≥r:</b> ${item.explain}</div>
      `;

      if(correct){
        score++;
        qDiv.classList.remove("wrong");
        qDiv.classList.add("correct");
        details.push(`<div class="good">‚úî ${cleanQuestionText(item.q)}</div>`);
      } else {
        qDiv.classList.remove("correct");
        qDiv.classList.add("wrong");
        details.push(`<div class="bad">‚úò ${cleanQuestionText(item.q)}</div>`);
      }
    });

    const percent = Math.round((score / openData.length) * 100);
    const grade = gradeFromPercent(percent);

    const result = document.getElementById("openResult");
    result.style.display = "block";
    result.innerHTML = `
      <h3>Wynik: ${score} / ${openData.length} (${percent}%) ‚Äî Ocena: <span class="${percent>=50?'good':'bad'}">${grade}</span></h3>
      <div class="small">Powt√≥rka: kliknij ‚ÄûPoka≈º tylko b≈Çƒôdne‚Äù.</div>
      <hr style="border:none;border-top:1px solid #e3e6f2;margin:10px 0;">
      ${details.join("")}
      <div class="footerNote">
        <b>Tip:</b> W otwartych liczƒÖ siƒô s≈Çowa-klucze. System dopuszcza wiele wersji i liter√≥wki,
        ale zawsze warto dopisaƒá konkret (np. rok + miejsce).
      </div>
    `;

    saveBest(`OTW: ${score}/${openData.length} (${percent}%)`, percent);
  }

  function resetOpen(){
    openData.forEach((_, idx)=>{
      document.getElementById(`open_${idx}`).value = "";
      const qDiv = document.getElementById(`openQ_${idx}`);
      qDiv.classList.remove("correct","wrong");
      const key = document.getElementById(`openKey_${idx}`);
      if(key) key.style.display = "none";
    });
    document.getElementById("openResult").style.display = "none";
    updateProgress("open");
    showAll("open");
  }

  function shuffleOPEN(){
    buildOPEN(OPEN_DRAW);
    renderOPEN();
    resetOpen();
  }

  // ===================== PROGRESS =====================
  function updateProgress(mode){
    if(mode==="abc"){
      const total = abcData.length;
      let filled = 0;
      for(let i=0;i<total;i++){
        const chosen = document.querySelector(`input[name="abc_${i}"]:checked`);
        if(chosen) filled++;
      }
      const pct = total ? Math.round((filled/total)*100) : 0;
      document.getElementById("abcProgressText").textContent = pct + "%";
      document.getElementById("abcProgressFill").style.width = pct + "%";
    } else {
      const total = openData.length;
      let filled = 0;
      for(let i=0;i<total;i++){
        const v = document.getElementById(`open_${i}`).value.trim();
        if(v) filled++;
      }
      const pct = total ? Math.round((filled/total)*100) : 0;
      document.getElementById("openProgressText").textContent = pct + "%";
      document.getElementById("openProgressFill").style.width = pct + "%";
    }
  }

  // ===================== SHOW WRONG ONLY / SHOW ALL =====================
  function showWrongOnly(mode){
    if(mode==="abc"){
      const qs = document.querySelectorAll("#abcQuestions .question");
      qs.forEach(q=>{
        if(!q.classList.contains("wrong")) q.style.display="none";
        else q.style.display="block";
      });
    } else {
      const qs = document.querySelectorAll("#openQuestions .question");
      qs.forEach(q=>{
        if(!q.classList.contains("wrong")) q.style.display="none";
        else q.style.display="block";
      });
    }
  }
  function showAll(mode){
    const selector = mode==="abc" ? "#abcQuestions .question" : "#openQuestions .question";
    document.querySelectorAll(selector).forEach(q=>q.style.display="block");
  }

  // ===================== OCENA =====================
  function gradeFromPercent(p){
    if(p>=95) return "6 (celujƒÖcy)";
    if(p>=85) return "5 (bardzo dobry)";
    if(p>=70) return "4 (dobry)";
    if(p>=50) return "3 (dostateczny)";
    if(p>=35) return "2 (dopuszczajƒÖcy)";
    return "1 (niedostateczny)";
  }

  // ===================== INIT: od razu losujemy z bazy =====================
  buildABC(ABC_DRAW, true);
  renderABC();

  buildOPEN(OPEN_DRAW);
  renderOPEN();
</script>

</body>
</html>
